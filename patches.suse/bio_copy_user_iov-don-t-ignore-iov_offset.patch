From: Al Viro <viro@zeniv.linux.org.uk>
Date: Sun, 24 Sep 2017 10:21:15 -0400
Subject: [PATCH] bio_copy_user_iov(): don't ignore ->iov_offset
References: bsc#1077989
Git-commit: 1cfd0ddd82232804e03f3023f6a58b50dfef0574
Patch-mainline: v4.14-rc5

Since "block: support large requests in blk_rq_map_user_iov" we
started to call it with partially drained iter; that works fine
on the write side, but reads create a copy of iter for completion
time.  And that needs to take the possibility of ->iov_iter != 0
into account...

Cc: stable@vger.kernel.org #v4.5+
Signed-off-by: Al Viro <viro@zeniv.linux.org.uk>
Signed-off-by: Hannes Reinecke <hare@suse.de>
---
 block/bio.c | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/block/bio.c b/block/bio.c
index 6a9680972e2d..71bc17aead37 100644
--- a/block/bio.c
+++ b/block/bio.c
@@ -1238,8 +1238,8 @@ struct bio *bio_copy_user_iov(struct request_queue *q,
 	 */
 	bmd->is_our_pages = map_data ? 0 : 1;
 	memcpy(bmd->iov, iter->iov, sizeof(struct iovec) * iter->nr_segs);
-	iov_iter_init(&bmd->iter, iter->type, bmd->iov,
-			iter->nr_segs, iter->count);
+	bmd->iter = *iter;
+	bmd->iter.iov = bmd->iov;
 
 	ret = -ENOMEM;
 	bio = bio_kmalloc(gfp_mask, nr_pages);
-- 
2.12.3

